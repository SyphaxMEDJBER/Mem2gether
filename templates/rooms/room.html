{% extends "base.html" %}
{% load static %}

{% block content %}

<!-- HEADER ROOM -->
<div class="room-header">
    <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
        <div class="text-start">
            <strong>Room {{ room.room_id }}</strong>
            <p class="mb-0 text-muted">
                Cr√©√©e par <span class="text-warning">{{ room.creator.username }}</span> ‚Ä¢ Mode :
                <span class="text-warning">
                    {% if room.mode == "youtube" %}YouTube{% else %}Photos{% endif %}
                </span>
            </p>
        </div>

        <div class="d-flex align-items-center gap-2">
            <span class="room-code">Code : {{ room.room_id }}</span>
        </div>
    </div>
</div>

<!-- WRAPPER PRINCIPAL -->
<div class="room-wrapper">

    <!-- SIDEBAR PARTICIPANTS -->
    <aside class="room-sidebar">
        <h5 class="mb-3">Participants</h5>

        {% if participants %}
            {% for p in participants %}
                <div class="participant-item d-flex justify-content-between align-items-center">
                    <span class="fw-semibold">{{ p.user.username }}</span>
                    {% if p.user == request.user %}
                        <span class="badge bg-success">Moi</span>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <p class="text-muted small">Aucun participant.</p>
        {% endif %}

        <hr class="my-4">

        <h5 class="mb-2">Infos room</h5>
        <ul class="list-unstyled text-muted" style="font-size: 0.9rem;">
            <li>‚Ä¢ ID : {{ room.room_id }}</li>
            <li>‚Ä¢ Cr√©ateur : {{ room.creator.username }}</li>
            <li>‚Ä¢ Mode :
                {% if room.mode == "youtube" %}YouTube{% else %}Photos{% endif %}
            </li>
            <li>‚Ä¢ Cr√©√©e le : {{ room.created_at|date:"d/m/Y H:i" }}</li>
        </ul>

        <div class="leave-room-fixed mt-4">
            <a href="/" class="btn btn-outline-light w-100">
                Quitter la room
            </a>
        </div>
    </aside>

    <!-- PANEL PRINCIPAL -->
    <section class="room-main">

        <!-- Boutons mode -->
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <div class="d-flex gap-2">
                <button id="btn-mode-photos" class="mode-btn active" type="button">Mode Photos</button>
                <button id="btn-mode-youtube" class="mode-btn" type="button">Mode YouTube</button>
            </div>

            <span class="text-muted small">
                Le changement de mode est pour l‚Äôinstant local (JavaScript).  synchroniser plus tard avec WebSockets.
            </span>
        </div>

        <!-- BLOC PRINCIPAL (centre de la page) -->
        <div class="sync-image-wrapper mb-3">

            <!-- MODE PHOTOS -->
            <div id="mode-photos">
                <div class="text-center px-3">
                    <p class="mb-2 text-muted">
                        Contenu synchronis√© (photo / vid√©o) appara√Ætra ici.
                    </p>
                </div>
            </div>

            <!-- MODE "YOUTUBE" (FAKE, LECTURE MP4) -->
            <div id="mode-youtube" class="d-none">
                <div class="px-3 mb-3">
                    <p class="mb-2 text-muted">
                        Colle une URL de <strong>vid√©o YouTube</strong> 
                    </p>

                    <div class="input-group mb-2">
                        <input type="text"
                               id="youtube-url-input"
                               class="form-control"
                               placeholder="https://www.youtube.com/watch?v=...">
                        <button class="btn btn-primary" type="button" id="youtube-load-btn">
                            Charger
                        </button>
                    </div>

                    <p class="text-muted small mb-2">
                       
                    </p>
                </div>

                <!-- LECTEUR VID√âO R√âDUIT ET CENTR√â -->
                <div class="video-wrapper text-center mt-3">
                    <video id="youtube-player"
                           controls
                           autoplay
                           class="video-player">
                        <source src="https://samplelib.com/lib/preview/mp4/sample-5s.mp4" type="video/mp4">
                        Votre navigateur ne supporte pas la lecture vid√©o.
                    </video>
                </div>
            </div>

        </div>

        <!-- ZONE BASSE : File d'attente / R√©actions / Chat -->
        <div class="row g-3">

            <!-- FILE D'ATTENTE -->
            <div class="col-md-4">
                <h5 class="mb-2">File d‚Äôattente</h5>
                <div class="queue-item">
                    <div class="flex-grow-1">
                        <p class="mb-1 fw-semibold">Aucun m√©dia</p>
                        <p class="mb-0 text-muted small">L‚Äôajout sera disponible plus tard.</p>
                    </div>
                </div>
            </div>

            <!-- R√âACTIONS -->
            <div class="col-md-4">
                <h5 class="mb-2">R√©actions</h5>

                <div id="reaction-buttons"
                     class="d-flex gap-2 mb-2"
                     data-room-id="{{ room.room_id }}">
                    <button type="button" class="reaction-btn btn btn-sm btn-outline-light" data-type="like">
                        üëç <span id="count-like">{{ reaction_counts.like }}</span>
                    </button>
                    <button type="button" class="reaction-btn btn btn-sm btn-outline-light" data-type="fun">
                        üòÇ <span id="count-fun">{{ reaction_counts.fun }}</span>
                    </button>
                    <button type="button" class="reaction-btn btn btn-sm btn-outline-light" data-type="wow">
                        üòÆ <span id="count-wow">{{ reaction_counts.wow }}</span>
                    </button>
                    <button type="button" class="reaction-btn btn btn-sm btn-outline-light" data-type="love">
                        ‚ù§Ô∏è <span id="count-love">{{ reaction_counts.love }}</span>
                    </button>
                </div>

                <p class="text-muted small">
                    Clique sur un emoji pour r√©agir. Un deuxi√®me clic retire ta r√©action.
                </p>
            </div>

            <!-- CHAT -->
            <div class="col-md-4">
                <h5 class="mb-2">Chat</h5>

                <!-- zone o√π les messages s'affichent -->
                <div id="chat-log" class="chat-container p-2 rounded-3 mb-2"
                     style="height: 180px; overflow-y:auto;">
                    <p class="text-muted small">Chat en direct.</p>
                </div>

                <!-- zone de saisie -->
                <div class="d-flex gap-2">
                    <input type="text" id="chat-message-input" class="form-control" placeholder="Message...">
                    <button type="button" id="chat-message-submit" class="btn btn-primary">Envoyer</button>
                </div>
            </div>

        </div>  <!-- fin .row -->

        <!-- STYLE LOCAL POUR LE LECTEUR VID√âO -->
        <style>
            .video-wrapper {
                display: flex;
                justify-content: center;
            }
            .video-player {
                width: 60%;
                max-width: 720px;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 0 16px rgba(0, 0, 0, 0.45);
                background: #000;
            }
            @media (max-width: 768px) {
                .video-player {
                    width: 100%;
                }
            }
        </style>

        <!-- SCRIPT CHAT -->
        <script>
        document.addEventListener("DOMContentLoaded", function () {
            const log   = document.getElementById("chat-log");
            const input = document.getElementById("chat-message-input");
            const btn   = document.getElementById("chat-message-submit");

            const roomId = "{{ room.room_id }}";

            let chatSocket = null;
            const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";

            try {
                chatSocket = new WebSocket(
                    protocol + window.location.host + "/ws/rooms/" + roomId + "/"
                );

                chatSocket.onmessage = function (e) {
                    const data = JSON.parse(e.data);
                    appendMessage(data.user + " : " + data.message);
                };

                chatSocket.onclose = function (e) {
                    console.warn("WebSocket ferm√©", e);
                };
            } catch (err) {
                console.error("Impossible d'ouvrir le WebSocket :", err);
            }

            function appendMessage(text) {
                const p = document.createElement("p");
                p.className = "mb-1 text-light";
                p.textContent = text;
                log.appendChild(p);
                log.scrollTop = log.scrollHeight;
            }

            function sendMessage() {
                const text = input.value.trim();
                if (!text) return;

                appendMessage("Moi : " + text);

                if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                    chatSocket.send(JSON.stringify({ "message": text }));
                } else {
                    console.warn("WebSocket non ouvert ‚Üí message seulement local");
                }

                input.value = "";
                input.focus();
            }

            btn.addEventListener("click", function (e) {
                e.preventDefault();
                sendMessage();
            });

            input.addEventListener("keydown", function (e) {
                if (e.key === "Enter") {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });
        </script>

        <!-- SCRIPT CHANGEMENT DE MODE (Photos / YouTube) -->
        <script>
        document.addEventListener("DOMContentLoaded", function () {
            const btnPhotos  = document.getElementById("btn-mode-photos");
            const btnYoutube = document.getElementById("btn-mode-youtube");
            const photosDiv  = document.getElementById("mode-photos");
            const youtubeDiv = document.getElementById("mode-youtube");

            function setMode(mode) {
                if (mode === "photos") {
                    btnPhotos.classList.add("active");
                    btnYoutube.classList.remove("active");
                    photosDiv.classList.remove("d-none");
                    youtubeDiv.classList.add("d-none");
                } else {
                    btnYoutube.classList.add("active");
                    btnPhotos.classList.remove("active");
                    youtubeDiv.classList.remove("d-none");
                    photosDiv.classList.add("d-none");
                }
            }

            btnPhotos.addEventListener("click", function () {
                setMode("photos");
            });

            btnYoutube.addEventListener("click", function () {
                setMode("youtube");
            });

            // Mode par d√©faut
            setMode("photos");
        });
        </script>

        <!-- SCRIPT "YOUTUBE" -->
        <script>
        document.addEventListener("DOMContentLoaded", function () {
            const input  = document.getElementById("youtube-url-input");
            const button = document.getElementById("youtube-load-btn");
            const video  = document.getElementById("youtube-player");

            if (!input || !button || !video) return;

            function loadFakeVideo() {
                const demoUrl = "https://samplelib.com/lib/preview/mp4/sample-5s.mp4";
                console.log("Lecture vid√©o de d√©mo :", demoUrl);

                video.pause();
                video.src = demoUrl;
                video.load();
                video.play().catch((err) => {
                    console.warn("Lecture auto bloqu√©e :", err);
                });
            }

            button.addEventListener("click", function () {
                loadFakeVideo();
            });

            input.addEventListener("keydown", function (e) {
                if (e.key === "Enter") {
                    e.preventDefault();
                    loadFakeVideo();
                }
            });
        });
        </script>

        <!-- SCRIPT R√âACTIONS -->
        <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        document.addEventListener("DOMContentLoaded", function () {
            const container = document.getElementById("reaction-buttons");
            if (!container) return;

            const roomId = container.dataset.roomId;
            const csrftoken = getCookie("csrftoken");

            document.querySelectorAll(".reaction-btn").forEach((btn) => {
                btn.addEventListener("click", function () {
                    const type = this.dataset.type;

                    fetch(`/rooms/${roomId}/react/`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": csrftoken,
                        },
                        body: JSON.stringify({ type: type }),
                    })
                    .then((response) => {
                        console.log("Status r√©action:", response.status);
                        return response.json();
                    })
                    .then((data) => {
                        console.log("R√©ponse JSON:", data);
                        if (data.counts) {
                            document.getElementById("count-like").textContent = data.counts.like;
                            document.getElementById("count-fun").textContent  = data.counts.fun;
                            document.getElementById("count-wow").textContent  = data.counts.wow;
                            document.getElementById("count-love").textContent = data.counts.love;
                        }
                    })
                    .catch((err) => {
                        console.error("Erreur r√©action :", err);
                    });
                });
            });
        });
        </script>

    </section>

</div>

{% endblock %}
