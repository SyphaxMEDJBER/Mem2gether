{% extends "base.html" %}
{% load static %}
{% block content %}

<div class="room-header">
    <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
        <div class="text-start">
            <strong>Room {{ room.room_id }}</strong>
            <p class="mb-0 text-muted">
                Créée par <span class="text-warning">{{ room.creator.username }}</span> — Mode :
                <span class="text-warning">{% if room.mode == "youtube" %}YouTube{% else %}Photos{% endif %}</span>
            </p>
        </div>
        <div><span class="room-code">Code : {{ room.room_id }}</span></div>
    </div>
</div>

<div class="room-wrapper">

    <aside class="room-sidebar">
        <div id="participants-list">
            <h5 class="mb-3">Participants</h5>
            {% for p in participants %}
                <div class="participant-item mb-1 d-flex justify-content-between align-items-center">
                    <span class="fw-semibold">{{ p.user.username }}</span>
                    {% if p.user == request.user %}
                        <span class="badge bg-success">Moi</span>
                    {% endif %}
                </div>
            {% endfor %}
        </div>

        <hr class="my-4" />

        <div id="room-info">
            <h5 class="mb-2">Infos room</h5>
            <ul class="list-unstyled text-muted small">
                <li>ID : {{ room.room_id }}</li>
                <li>Créateur : {{ room.creator.username }}</li>
                <li>Mode : {% if room.mode == "youtube" %}YouTube{% else %}Photos{% endif %}</li>
                <li>Créée le : {{ room.created_at|date:"d/m/Y H:i" }}</li>
            </ul>

            <a href="/rooms/{{ room.room_id }}/leave/" class="btn btn-outline-light w-100 mt-4">
                Quitter la room
            </a>
        </div>
    </aside>

    <section class="room-main">

        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <div class="d-flex gap-2">
                <button class="mode-btn active" type="button" disabled>Mode Photos</button>
                <button class="mode-btn" type="button" disabled>Mode YouTube</button>
            </div>
            <span class="text-muted small">Synchro vidéo bientôt.</span>
        </div>

        <!-- PHOTO -->
        <div class="sync-image-wrapper mb-3 text-center" id="photo-wrapper">
            {% if images %}
                {% for img in images %}
                    {% if img.is_displayed %}
                        <img id="sync-image" src="{{ img.image_url }}" style="max-height:100%; max-width:100%; border-radius:12px;">
                        <p class="text-muted mt-2">Ajoutée par <strong>{{ img.uploaded_by.username }}</strong></p>
                    {% endif %}
                {% endfor %}
            {% else %}
                <p id="no-photo" class="text-muted">Aucune image pour l’instant.</p>
            {% endif %}
        </div>

        <!-- UPLOAD -->
        <form method="POST" enctype="multipart/form-data" class="mb-4">
            {% csrf_token %}
            <input type="file" name="image" accept="image/*" required class="form-control mb-2">
            <button type="submit" class="btn btn-primary w-100">Ajouter une image</button>
        </form>

        <div class="row g-3">

            <div class="col-md-4">
                <h5 class="mb-2">File d’attente</h5>
                {% for img in images %}
                    <div class="queue-item">
                        <img src="{{ img.image_url }}">
                        <div>
                            <div class="fw-semibold">#{{ img.position }}</div>
                            <div class="text-muted small">par {{ img.uploaded_by.username }}</div>
                        </div>
                    </div>
                {% empty %}
                    <div class="queue-item">
                        <p class="mb-1 fw-semibold">Aucun média</p>
                    </div>
                {% endfor %}
            </div>

            <div class="col-md-8">
                <h5 class="mb-2">Chat</h5>

                <div id="chat-log" class="p-2 rounded-3 mb-2"
                     style="height:180px; overflow-y:auto; background:#222;">
                    {% for m in messages %}
                        <p class="mb-1 text-light">
                            <strong>{% if m.user %}{{ m.user.username }}{% else %}Anonyme{% endif %} :</strong>
                            {{ m.content }}
                        </p>
                    {% endfor %}
                </div>

                <div class="d-flex gap-2">
                    <input type="text" id="chat-message-input" class="form-control" placeholder="Message..." />
                    <button id="chat-message-submit" class="btn btn-primary">Envoyer</button>
                </div>
            </div>

        </div>

    </section>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const currentUser = "{{ request.user.username }}";

    // ===== WS CHAT (restauré) =====
    const chatSocket = new WebSocket(
        (location.protocol === "https:" ? "wss://" : "ws://")
        + location.host + "/ws/rooms/{{ room.room_id }}/"
    );

    chatSocket.onmessage = e => {
        const data = JSON.parse(e.data);

        if (data.type === "participants") {
            const list = document.getElementById("participants-list");
            let html = "<h5 class='mb-3'>Participants</h5>";

            data.participants.forEach(u => {
                if (u === currentUser) {
                    html += `
                        <div class="participant-item d-flex justify-content-between align-items-center">
                            <span class="fw-semibold">${u}</span>
                            <span class="badge bg-success">Moi</span>
                        </div>`;
                } else {
                    html += `<div class="participant-item"><span class="fw-semibold">${u}</span></div>`;
                }
            });

            list.innerHTML = html;
        }

        if (data.type === "room_closed") {
            window.location.href = "/";
        }

        if (data.type === "chat") {
            const log = document.getElementById("chat-log");
            const p = document.createElement("p");
            p.className = "mb-1 text-light";
            p.innerHTML = "<strong>" + data.user + " :</strong> " + data.message;
            log.appendChild(p);
            log.scrollTop = log.scrollHeight;
        }
    };

    document.getElementById("chat-message-submit").onclick = () => {
        const input = document.getElementById("chat-message-input");
        const val = input.value.trim();
        if (!val) return;
        chatSocket.send(JSON.stringify({ message: val }));
        input.value = "";
    };

    // ===== WS PHOTOS (temps réel) =====
    const photoSocket = new WebSocket(
        (location.protocol === "https:" ? "wss://" : "ws://")
        + location.host + "/ws/photos/{{ room.room_id }}/"
    );

    const photoWrapper = document.getElementById("photo-wrapper");

    function renderPhoto(url, user) {
        photoWrapper.innerHTML = `
            <img id="sync-image" src="${url}?t=${Date.now()}" style="max-height:100%; max-width:100%; border-radius:12px;">
            <p class="text-muted mt-2">Ajoutée par <strong>${user}</strong></p>
        `;
    }

    photoSocket.onmessage = e => {
        const data = JSON.parse(e.data);
        if (data.type === "photo" && data.url) {
            renderPhoto(data.url, data.user || "Anonyme");
        }
    };

    // ===== FALLBACK HTTP (si WS photos ne marche pas) =====
    async function refreshCurrentPhoto() {
        try {
            const r = await fetch("/rooms/{{ room.room_id }}/current-image/");
            const data = await r.json();
            if (data.url) renderPhoto(data.url, data.user || "Anonyme");
        } catch {}
    }
    refreshCurrentPhoto();
    setInterval(refreshCurrentPhoto, 3000);

});
</script>

{% endblock %}
