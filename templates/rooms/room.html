{% extends "base.html" %}
{% load static %}

{% block content %}

<div class="room-header">
    <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
        <div class="text-start">
            <strong>Room {{ room.room_id }}</strong>
            <p class="mb-0 text-muted">
                Cr√©√©e par <span class="text-warning">{{ room.creator.username }}</span> ‚Ä¢ Mode :
                <span class="text-warning">
                    {% if room.mode == "youtube" %}YouTube{% else %}Photos{% endif %}
                </span>
            </p>
        </div>
        <div><span class="room-code">Code : {{ room.room_id }}</span></div>
    </div>
</div>

<div class="room-wrapper">

    <aside class="room-sidebar">
        <div id="participants-list">
            <h5 class="mb-3">Participants</h5>
            {% for p in participants %}
                <div class="participant-item mb-1 d-flex justify-content-between align-items-center">
                    <span class="fw-semibold">{{ p.user.username }}</span>
                    {% if p.user == request.user %}
                        <span class="badge bg-success">Moi</span>
                    {% endif %}
                </div>
            {% endfor %}
        </div>

        <hr class="my-4" />

        <div id="room-info">
            <h5 class="mb-2">Infos room</h5>
            <ul class="list-unstyled text-muted small">
                <li>‚Ä¢ ID : {{ room.room_id }}</li>
                <li>‚Ä¢ Cr√©ateur : {{ room.creator.username }}</li>
                <li>‚Ä¢ Mode : {% if room.mode == "youtube" %}YouTube{% else %}Photos{% endif %}</li>
                <li>‚Ä¢ Cr√©√©e le : {{ room.created_at|date:"d/m/Y H:i" }}</li>
            </ul>

            <a href="/rooms/{{ room.room_id }}/leave/" class="btn btn-outline-light w-100 mt-4">
                Quitter la room
            </a>
        </div>
    </aside>

    <section class="room-main">

        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <div class="d-flex gap-2">
                <button class="mode-btn active" type="button" disabled>Mode Photos</button>
                <button class="mode-btn" type="button" disabled>Mode YouTube</button>
            </div>
            <span class="text-muted small">Synchro vid√©o bient√¥t.</span>
        </div>

        <div class="sync-image-wrapper mb-3 text-center">
            <p class="text-muted">Contenu synchronis√© appara√Ætra ici.</p>
        </div>

        <div class="row g-3">

            <div class="col-md-4">
                <h5 class="mb-2">File d‚Äôattente</h5>
                <div class="queue-item">
                    <p class="mb-1 fw-semibold">Aucun m√©dia</p>
                </div>
            </div>

            <div class="col-md-4">
                <h5 class="mb-2">R√©actions</h5>

                <div class="d-flex gap-2 mb-2">
                    <button class="reaction-btn" data-react="üëç">üëç</button>
                    <button class="reaction-btn" data-react="üòÇ">üòÇ</button>
                    <button class="reaction-btn" data-react="üòÆ">üòÆ</button>
                    <button class="reaction-btn" data-react="üíî">üíî</button>
                </div>

                <div id="reaction-display" class="text-warning fw-bold"></div>
            </div>

            <div class="col-md-4">
                <h5 class="mb-2">Chat</h5>

                <div id="chat-log" class="p-2 rounded-3 mb-2"
                     style="height:180px; overflow-y:auto; background:#222;">

                    {% for m in messages %}
                        <p class="mb-1 text-light">
                            <strong>
                                {% if m.user %}
                                    {{ m.user.username }}
                                {% else %}
                                    Anonyme
                                {% endif %}
                            :</strong> {{ m.content }}
                        </p>
                    {% endfor %}

                </div>

                <div class="d-flex gap-2">
                    <input type="text" id="chat-message-input" class="form-control" placeholder="Message..." />
                    <button id="chat-message-submit" class="btn btn-primary">Envoyer</button>
                </div>

            </div>

        </div>

    </section>

</div>

<script>
const protocol = location.protocol === "https:" ? "wss://" : "ws://";
const roomId = "{{ room.room_id }}";
const socket = new WebSocket(protocol + location.host + "/ws/rooms/" + roomId + "/");

socket.onmessage = function(e) {
    const data = JSON.parse(e.data);

    // CHAT
    if (data.message) {
        const log = document.getElementById("chat-log");
        const p = document.createElement("p");
        p.textContent = data.user + " : " + data.message;
        log.appendChild(p);
        log.scrollTop = log.scrollHeight;
    }

    // PARTICIPANTS
    if (data.type === "participants") {
        const list = document.getElementById("participants-list");
        let html = "<h5 class='mb-3'>Participants</h5>";

        data.participants.forEach(name => {
            if (name === "{{ request.user.username }}") {
                html += `<div class="participant-item">
                            ${name} <span class="badge bg-success">Moi</span>
                         </div>`;
            } else {
                html += `<div class="participant-item">${name}</div>`;
            }
        });

        list.innerHTML = html;
    }
};

document.getElementById("chat-message-submit").onclick = send;
document.getElementById("chat-message-input").onkeydown = e => {
    if (e.key === "Enter") send();
};

function send() {
    const input = document.getElementById("chat-message-input");
    if (!input.value.trim()) return;
    socket.send(JSON.stringify({ message: input.value }));
    input.value = "";
}
</script>

{% endblock %}
