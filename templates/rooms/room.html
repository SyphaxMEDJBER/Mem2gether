{# templates/rooms/room.html #}
{% extends "base.html" %}
{% load static %}
{% block content %}

<div class="room-header">
    <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
        <div class="text-start">
            <strong>Room {{ room.room_id }}</strong>
            <p class="mb-0 text-muted">
                Cr√©√©e par <span class="text-warning">{{ room.creator.username }}</span> ‚Äî Mode :
                <span class="text-warning" id="room-mode-label">{% if room.mode == "youtube" %}YouTube{% else %}Photos{% endif %}</span>
            </p>
        </div>
        <div><span class="room-code">Code : {{ room.room_id }}</span></div>
    </div>
</div>

<div class="room-wrapper">

    <aside class="room-sidebar">
        <div id="participants-list">
            <h5 class="mb-3">Participants</h5>
            {% for p in participants %}
                <div class="participant-item mb-1 d-flex justify-content-between align-items-center">
                    <span class="fw-semibold">{{ p.user.username }}</span>
                    {% if p.user == request.user %}
                        <span class="badge bg-success">Moi</span>
                    {% endif %}
                </div>
            {% endfor %}
        </div>

        <hr class="my-4" />

        <div id="room-info">
            <h5 class="mb-2">Infos room</h5>
            <ul class="list-unstyled text-muted small">
                <li>ID : {{ room.room_id }}</li>
                <li>Cr√©ateur : {{ room.creator.username }}</li>
                <li>Mode : <span id="room-mode-info">{% if room.mode == "youtube" %}YouTube{% else %}Photos{% endif %}</span></li>
                <li>Cr√©√©e le : {{ room.created_at|date:"d/m/Y H:i" }}</li>
            </ul>

            <a href="/rooms/{{ room.room_id }}/leave/" class="btn btn-outline-light w-100 mt-4">
                Quitter la room
            </a>
        </div>
    </aside>

    <section class="room-main">

        <!-- MODE SWITCH -->
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <div class="d-flex gap-2">
                <button class="mode-btn {% if room.mode == 'photos' %}active{% endif %}" data-mode="photos" type="button">
                    Mode Photos
                </button>
                <button class="mode-btn {% if room.mode == 'youtube' %}active{% endif %}" data-mode="youtube" type="button">
                    Mode YouTube
                </button>
            </div>
            <span class="text-muted small">Synchronisation en temps r√©el</span>
        </div>

        <!-- ===================== PHOTOS MODE ===================== -->
        <div id="photos-mode" {% if room.mode != "photos" %}style="display:none;"{% endif %}>

            <div class="sync-image-wrapper mb-3 text-center" id="photo-wrapper">
                {% if images %}
                    {% for img in images %}
                        {% if img.is_displayed %}
                            <img id="sync-image" src="{{ img.image_url }}" style="max-height:100%; max-width:100%; border-radius:12px;">
                            <p class="text-muted mt-2">Ajout√©e par <strong>{{ img.uploaded_by.username }}</strong></p>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <p id="no-photo" class="text-muted">Aucune image pour l‚Äôinstant.</p>
                {% endif %}
            </div>

            <form method="POST" enctype="multipart/form-data" class="mb-4">
                {% csrf_token %}
                <input type="file" name="image" accept="image/*" required class="form-control mb-2">
                <button type="submit" class="btn btn-primary w-100">Ajouter une image</button>
            </form>

            <div class="row g-3">
                <div class="col-md-4">
                    <h5 class="mb-2">File d‚Äôattente</h5>
                    <div id="queue-list">
                        {% for img in images %}
                            <div class="queue-item" data-image-id="{{ img.id }}">
                                <img src="{{ img.image_url }}">
                                <div>
                                    <div class="fw-semibold">#{{ img.position }}</div>
                                    <div class="text-muted small">par {{ img.uploaded_by.username }}</div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="queue-item">
                                <p class="mb-1 fw-semibold">Aucun m√©dia</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="col-md-8">
                    <h5 class="mb-2">Chat</h5>

                    <div id="chat-log" class="p-2 rounded-3 mb-2"
                         style="height:180px; overflow-y:auto; background:#222;">
                        {% for m in messages %}
                            <p class="mb-1 text-light">
                                <strong>{% if m.user %}{{ m.user.username }}{% else %}Anonyme{% endif %} :</strong>
                                {{ m.content }}
                            </p>
                        {% endfor %}
                    </div>

                    <div class="d-flex gap-2">
                        <input type="text" id="chat-message-input" class="form-control" placeholder="Message..." />
                        <button id="chat-message-submit" class="btn btn-primary">Envoyer</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===================== YOUTUBE MODE ===================== -->
        <div id="youtube-mode" {% if room.mode != "youtube" %}style="display:none;"{% endif %}>

            <div class="sync-image-wrapper mb-3" style="padding:0;">
                <div id="yt-player" style="width:100%; height:100%;"></div>
            </div>

            <form method="POST" class="mb-4">
                {% csrf_token %}
                <input type="text" name="youtube_url" class="form-control mb-2" placeholder="Lien YouTube ou ID vid√©o" />
                <button type="submit" class="btn btn-primary w-100">D√©finir la vid√©o</button>
            </form>

            <div class="d-flex gap-2 mb-3 flex-wrap">
                <button id="yt-play" class="btn btn-primary" type="button">Play</button>
                <button id="yt-pause" class="btn btn-outline-light" type="button">Pause</button>
                <button id="yt-sync" class="btn btn-outline-light" type="button">Sync</button>
            </div>

            <div class="row g-3">
                <div class="col-md-12">
                    <h5 class="mb-2">Chat</h5>

                    <div id="chat-log-yt" class="p-2 rounded-3 mb-2"
                         style="height:200px; overflow-y:auto; background:#222;">
                        {% for m in messages %}
                            <p class="mb-1 text-light">
                                <strong>{% if m.user %}{{ m.user.username }}{% else %}Anonyme{% endif %} :</strong>
                                {{ m.content }}
                            </p>
                        {% endfor %}
                    </div>

                    <div class="d-flex gap-2">
                        <input type="text" id="chat-message-input-yt" class="form-control" placeholder="Message..." />
                        <button id="chat-message-submit-yt" class="btn btn-primary">Envoyer</button>
                    </div>
                </div>
            </div>

        </div>

    </section>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const currentUser = "{{ request.user.username }}";
    const roomId = "{{ room.room_id }}";
    const protocol = (location.protocol === "https:" ? "wss://" : "ws://");
    const photosModeEl = document.getElementById("photos-mode");
    const ytModeEl = document.getElementById("youtube-mode");
    const modeLabelEl = document.getElementById("room-mode-label");
    const modeInfoEl = document.getElementById("room-mode-info");
    const modeButtons = document.querySelectorAll("[data-mode]");
    let currentMode = "{{ room.mode }}";
    let ytSocket = null;

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
        return "";
    }

    function setMode(mode) {
        if (!mode) return;
        currentMode = mode;
        const label = (mode === "youtube") ? "YouTube" : "Photos";
        if (photosModeEl) photosModeEl.style.display = (mode === "photos") ? "" : "none";
        if (ytModeEl) ytModeEl.style.display = (mode === "youtube") ? "" : "none";
        if (modeLabelEl) modeLabelEl.textContent = label;
        if (modeInfoEl) modeInfoEl.textContent = label;

        modeButtons.forEach(btn => {
            btn.classList.toggle("active", btn.dataset.mode === mode);
        });

        if (mode === "youtube") {
            ensureYouTubeAPI();
            requestYTSync();
        }
    }

    async function requestMode(mode) {
        if (!mode || mode === currentMode) return;
        const csrftoken = getCookie("csrftoken");
        try {
            const res = await fetch(`/rooms/${roomId}/set-mode/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": csrftoken
                },
                body: `mode=${encodeURIComponent(mode)}`
            });
            if (!res.ok) throw new Error("bad response");
            const data = await res.json();
            if (data.mode) setMode(data.mode);
        } catch (err) {
            console.log("mode switch failed", err);
        }
    }

    modeButtons.forEach(btn => {
        btn.addEventListener("click", () => {
            requestMode(btn.dataset.mode);
        });
    });

    // ================= WS CHAT =================
    const chatSocket = new WebSocket(protocol + location.host + "/ws/rooms/" + roomId + "/");

    function appendChat(targetId, user, msg){
        const log = document.getElementById(targetId);
        if (!log) return;
        const p = document.createElement("p");
        p.className = "mb-1 text-light";
        p.innerHTML = "<strong>" + user + " :</strong> " + msg;
        log.appendChild(p);
        log.scrollTop = log.scrollHeight;
    }

    chatSocket.onmessage = e => {
        const data = JSON.parse(e.data);

        if (data.type === "participants") {
            const list = document.getElementById("participants-list");
            let html = "<h5 class='mb-3'>Participants</h5>";

            (data.participants || []).forEach(u => {
                if (u === currentUser) {
                    html += `
                        <div class="participant-item d-flex justify-content-between align-items-center">
                            <span class="fw-semibold">${u}</span>
                            <span class="badge bg-success">Moi</span>
                        </div>`;
                } else {
                    html += `<div class="participant-item"><span class="fw-semibold">${u}</span></div>`;
                }
            });

            list.innerHTML = html;
        }

        if (data.type === "mode") {
            setMode(data.mode);
        }

        if (data.type === "room_closed") {
            window.location.href = "/";
        }

        if (data.type === "chat") {
            appendChat("chat-log", data.user, data.message);
            appendChat("chat-log-yt", data.user, data.message);
        }
    };

    function bindChat(inputId, btnId){
        const input = document.getElementById(inputId);
        const btn = document.getElementById(btnId);
        if (!input || !btn) return;

        const send = () => {
            const val = input.value.trim();
            if (!val) return;
            chatSocket.send(JSON.stringify({ message: val }));
            input.value = "";
        };

        btn.onclick = send;
        input.onkeydown = e => { if (e.key === "Enter") send(); };
    }

    bindChat("chat-message-input", "chat-message-submit");
    bindChat("chat-message-input-yt", "chat-message-submit-yt");

    // ================= WS PHOTOS =================
    const photoSocket = new WebSocket(protocol + location.host + "/ws/photos/" + roomId + "/");
    const photoWrapper = document.getElementById("photo-wrapper");
    const queueList = document.getElementById("queue-list");

    function renderPhoto(url, user) {
        if (!photoWrapper) return;
        photoWrapper.innerHTML = `
            <img id="sync-image" src="${url}?t=${Date.now()}" style="max-height:100%; max-width:100%; border-radius:12px;">
            <p class="text-muted mt-2">Ajout√©e par <strong>${user}</strong></p>
        `;
    }

    photoSocket.onmessage = e => {
        const data = JSON.parse(e.data);
        if (data.type === "photo" && data.url) {
            renderPhoto(data.url, data.user || "Anonyme");
            if (queueList && data.id) {
                const existing = queueList.querySelector(`[data-image-id="${data.id}"]`);
                if (!existing) {
                    const item = document.createElement("div");
                    item.className = "queue-item";
                    item.dataset.imageId = data.id;
                    item.innerHTML = `
                        <img src="${data.url}">
                        <div>
                            <div class="fw-semibold">#${data.position || ""}</div>
                            <div class="text-muted small">par ${data.user || "Anonyme"}</div>
                        </div>
                    `;
                    queueList.appendChild(item);
                }
            }
        }
    };

    function bindQueueClicks() {
        const list = document.getElementById("queue-list");
        if (!list) return;
        list.addEventListener("click", async (e) => {
            const item = e.target.closest(".queue-item[data-image-id]");
            if (!item) return;
            const imageId = item.dataset.imageId;
            if (!imageId) return;
            const csrftoken = getCookie("csrftoken");
            try {
                const res = await fetch(`/rooms/${roomId}/set-image/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "X-CSRFToken": csrftoken
                    },
                    body: `image_id=${encodeURIComponent(imageId)}`
                });
                if (!res.ok) throw new Error("bad response");
            } catch (err) {
                console.log("set image failed", err);
            }
        });
    }

    async function refreshCurrentPhoto() {
        try {
            const r = await fetch("/rooms/" + roomId + "/current-image/");
            const data = await r.json();
            if (data.url) renderPhoto(data.url, data.user || "Anonyme");
        } catch {}
    }
    bindQueueClicks();
    refreshCurrentPhoto();
    setInterval(refreshCurrentPhoto, 3000);

    // ================= YOUTUBE =================
    ytSocket = new WebSocket(protocol + location.host + "/ws/youtube/" + roomId + "/");

    let player = null;
    let ytReady = false;
    let suppress = false;
    let pendingYTEvent = null;
    let pendingSyncRequest = false;

    function sendYT(payload){
        try { ytSocket.send(JSON.stringify(payload)); } catch {}
    }

    function requestYTSync(){
        if (!ytSocket) return;
        if (ytSocket.readyState === WebSocket.OPEN) {
            sendYT({type: "sync_request"});
        } else {
            pendingSyncRequest = true;
        }
    }

    function ensureYouTubeAPI(){
        if (window.YT && window.YT.Player) return;
        const s = document.createElement("script");
        s.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(s);
    }

    window.onYouTubeIframeAPIReady = function(){
        player = new YT.Player("yt-player", {
            videoId: "{{ room.youtube_video_id|default:'' }}",
            playerVars: { playsinline: 1, controls: 1 },
            events: {
                onReady: () => {
                    ytReady = true;
                    if (pendingYTEvent) {
                        applyYT(pendingYTEvent);
                        pendingYTEvent = null;
                    }
                },
                onStateChange: (ev) => {
                    if (suppress) return;
                    if (!ytReady) return;

                    const t = player.getCurrentTime ? player.getCurrentTime() : 0;

                    if (ev.data === YT.PlayerState.PLAYING) sendYT({type:"play", t});
                    if (ev.data === YT.PlayerState.PAUSED)  sendYT({type:"pause", t});
                }
            }
        });
    };

    function applyYT(ev){
        if (!player || !ytReady) {
            pendingYTEvent = ev;
            return;
        }

        suppress = true;

        try {
            if (ev.type === "init") {
                if (ev.videoId) {
                    player.loadVideoById(ev.videoId, ev.t || 0);
                }
                if (ev.state === "playing") {
                    setTimeout(() => { player.playVideo(); }, 200);
                } else if (ev.state === "paused") {
                    setTimeout(() => { player.pauseVideo(); }, 200);
                }
            }

            if (ev.type === "set_video" && ev.videoId) {
                player.loadVideoById(ev.videoId, ev.t || 0);
            }

            if (ev.type === "play") {
                if (typeof ev.t === "number") player.seekTo(ev.t, true);
                player.playVideo();
            }

            if (ev.type === "pause") {
                if (typeof ev.t === "number") player.seekTo(ev.t, true);
                player.pauseVideo();
            }

            if (ev.type === "seek") {
                if (typeof ev.t === "number") player.seekTo(ev.t, true);
            }

            if (ev.type === "sync") {
                if (typeof ev.t === "number") player.seekTo(ev.t, true);
                if (ev.state === "playing") player.playVideo();
                if (ev.state === "paused")  player.pauseVideo();
            }
        } finally {
            setTimeout(() => { suppress = false; }, 200);
        }
    }

    ytSocket.onopen = () => {
        if (pendingSyncRequest) {
            sendYT({type: "sync_request"});
            pendingSyncRequest = false;
        }
    };

    ytSocket.onmessage = e => {
        const ev = JSON.parse(e.data);
        applyYT(ev);
    };

    // Controls
    const btnPlay = document.getElementById("yt-play");
    const btnPause = document.getElementById("yt-pause");
    const btnSync = document.getElementById("yt-sync");

    if (btnPlay) btnPlay.onclick = () => {
        if (!player || !ytReady) return;
        const t = player.getCurrentTime();
        sendYT({type:"play", t});
        applyYT({type:"play", t});
    };

    if (btnPause) btnPause.onclick = () => {
        if (!player || !ytReady) return;
        const t = player.getCurrentTime();
        sendYT({type:"pause", t});
        applyYT({type:"pause", t});
    };

    if (btnSync) btnSync.onclick = () => {
        if (!player || !ytReady) return;
        const t = player.getCurrentTime();
        const state = player.getPlayerState() === 1 ? "playing" : "paused";
        sendYT({type:"sync", t, state});
        applyYT({type:"sync", t, state});
    };

    setMode(currentMode);

});
</script>

<!-- REACTIONS -->
<div class="mt-3">
    <h5>R√©actions</h5>
    <div class="d-flex gap-2">
        <button class="reaction-btn" data-reaction="üî•">üî•</button>
        <button class="reaction-btn" data-reaction="üòÇ">üòÇ</button>
        <button class="reaction-btn" data-reaction="‚ù§Ô∏è">‚ù§Ô∏è</button>
        <button class="reaction-btn" data-reaction="üòÆ">üòÆ</button>

    </div>
    <div id="reaction-feed" class="mt-2 text-warning fw-bold"></div>
</div>
<script>
document.addEventListener("DOMContentLoaded", () => {

  const feed = document.getElementById("reaction-feed");
  const reactionSocket = new WebSocket(
    (location.protocol === "https:" ? "wss://" : "ws://") +
    location.host + "/ws/reactions/{{ room.room_id }}/"
  );

  reactionSocket.onopen  = () => console.log(" WS reactions CONNECTED");
  reactionSocket.onerror = (e) => console.log(" WS reactions ERROR", e);
  reactionSocket.onclose = () => console.log(" WS reactions CLOSED");

  function showReactionLocally(user, reaction){
    if (!feed) return;
    feed.textContent = `${user} ${reaction}`;
  }

  document.querySelectorAll(".reaction-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        const reaction = btn.dataset.reaction || btn.textContent;
        if (reactionSocket.readyState === WebSocket.OPEN) {
            reactionSocket.send(JSON.stringify({ reaction }));
        }
    });

  });

  reactionSocket.onmessage = e => {
    const data = JSON.parse(e.data);
    const feed = document.getElementById("reaction-feed");
    if (!feed) return;

    const span = document.createElement("span");
    span.className = "me-2";
    span.textContent = `${data.user} ${data.reaction}`;

    feed.appendChild(span);
};


});
</script>
{% endblock %}
