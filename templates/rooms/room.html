{% extends "base.html" %}
{% load static %}

{% block content %}

<!-- HEADER ROOM -->
<div class="room-header">
    <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
        <div class="text-start">
            <strong>Room {{ room.room_id }}</strong>
            <p class="mb-0 text-muted">
                Cr√©√©e par <span class="text-warning">{{ room.creator.username }}</span> ‚Ä¢ Mode :
                <span class="text-warning">
                    {% if room.mode == "youtube" %}YouTube{% else %}Photos{% endif %}
                </span>
            </p>
        </div>

        <div class="d-flex align-items-center gap-2">
            <span class="room-code">Code : {{ room.room_id }}</span>
        </div>
    </div>
</div>

<!-- WRAPPER PRINCIPAL -->
<div class="room-wrapper">

    <!-- SIDEBAR PARTICIPANTS -->
    <aside class="room-sidebar">
        <h5 class="mb-3">Participants</h5>

        {% if participants %}
            {% for p in participants %}
                <div class="participant-item d-flex justify-content-between align-items-center">
                    <span class="fw-semibold">{{ p.user.username }}</span>
                    {% if p.user == request.user %}
                        <span class="badge bg-success">Moi</span>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <p class="text-muted small">Aucun participant.</p>
        {% endif %}

        <hr class="my-4">

        <h5 class="mb-2">Infos room</h5>
        <ul class="list-unstyled text-muted" style="font-size: 0.9rem;">
            <li>‚Ä¢ ID : {{ room.room_id }}</li>
            <li>‚Ä¢ Cr√©ateur : {{ room.creator.username }}</li>
            <li>‚Ä¢ Mode :
                {% if room.mode == "youtube" %}YouTube{% else %}Photos{% endif %}
            </li>
            <li>‚Ä¢ Cr√©√©e le : {{ room.created_at|date:"d/m/Y H:i" }}</li>
        </ul>

        <div class="leave-room-fixed mt-4">
            <a href="/" class="btn btn-outline-light w-100">
                Quitter la room
            </a>
        </div>
    </aside>

    <!-- PANEL PRINCIPAL -->
    <section class="room-main">

        <!-- Boutons mode -->
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <div class="d-flex gap-2">
                <button class="mode-btn active" type="button" disabled>Mode Photos</button>
                <button class="mode-btn" type="button" disabled>Mode YouTube</button>
            </div>

            <span class="text-muted small">
                Le changement de mode sera activ√© plus tard (WebSockets).
            </span>
        </div>

        <!-- Media principal -->
        <div class="sync-image-wrapper mb-3">
            <div class="text-center px-3">
                <p class="mb-2 text-muted">Contenu synchronis√© (photo / vid√©o) appara√Ætra ici.</p>
            </div>
        </div>

        <!-- Split bottom zone -->
        <div class="row g-3">

            <!-- FILE D'ATTENTE -->
            <div class="col-md-4">
                <h5 class="mb-2">File d‚Äôattente</h5>
                <div class="queue-item">
                    <div class="flex-grow-1">
                        <p class="mb-1 fw-semibold">Aucun m√©dia</p>
                        <p class="mb-0 text-muted small">L‚Äôajout sera disponible plus tard.</p>
                    </div>
                </div>
            </div>

            <!-- R√âACTIONS -->
            <div class="col-md-4">
                <h5 class="mb-2">R√©actions</h5>
                <div class="d-flex gap-2 mb-2">
                    <button class="reaction-btn" disabled>üëç</button>
                    <button class="reaction-btn" disabled>üòÇ</button>
                    <button class="reaction-btn" disabled>üòÆ</button>
                    <button class="reaction-btn" disabled>üíî</button>
                </div>
                <p class="text-muted small">Les r√©actions en temps r√©el arrivent plus tard.</p>
            </div>

           <!-- CHAT -->
<div class="col-md-4">
    <h5 class="mb-2">Chat</h5>

    <!-- zone o√π les messages s'affichent -->
    <div id="chat-log" class="chat-container p-2 rounded-3 mb-2"
         style="height: 180px; overflow-y:auto;">
        <p class="text-muted small">Chat en direct.</p>
    </div>

    <!-- zone de saisie -->
    <div class="d-flex gap-2">
        <input type="text" id="chat-message-input" class="form-control" placeholder="Message...">
        <button type="button" id="chat-message-submit" class="btn btn-primary">Envoyer</button>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const log   = document.getElementById("chat-log");
    const input = document.getElementById("chat-message-input");
    const btn   = document.getElementById("chat-message-submit");

    const roomId = "{{ room.room_id }}";  // tu utilises room.room_id dans le template

    // On essaie d'ouvrir un WebSocket, mais ce n'est pas obligatoire pour afficher localement
    let chatSocket = null;
    const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";

    try {
        chatSocket = new WebSocket(
            protocol + window.location.host + "/ws/rooms/" + roomId + "/"
        );

        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            appendMessage(data.user + " : " + data.message);
        };

        chatSocket.onclose = function (e) {
            console.warn("WebSocket ferm√©", e);
        };
    } catch (err) {
        console.error("Impossible d'ouvrir le WebSocket :", err);
    }

    function appendMessage(text) {
        const p = document.createElement("p");
        p.className = "mb-1 text-light";
        p.textContent = text;
        log.appendChild(p);
        log.scrollTop = log.scrollHeight;
    }

    function sendMessage() {
        const text = input.value.trim();
        if (!text) return;

        // Toujours l'afficher pour moi
        appendMessage("Moi : " + text);

        // Essayer de l'envoyer aux autres via WebSocket
        if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({ "message": text }));
        } else {
            console.warn("WebSocket non ouvert ‚Üí message seulement local");
        }

        input.value = "";
        input.focus();
    }

    btn.addEventListener("click", function (e) {
        e.preventDefault();
        sendMessage();
    });

    input.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
            sendMessage();
        }
    });
});
</script>

        </div>

    </section>

</div>

{% endblock %}
